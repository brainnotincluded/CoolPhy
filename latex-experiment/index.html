<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live LaTeX Editor</title>
    
    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <!-- Mermaid for diagrams -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: false, theme: 'dark' });
        window.mermaid = mermaid;
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        
        header {
            padding: 20px;
            background: #252526;
            border-bottom: 1px solid #3e3e42;
        }
        
        h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .subtitle {
            font-size: 14px;
            color: #858585;
            margin-top: 5px;
        }
        
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .editor-pane, .preview-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .pane-header {
            padding: 12px 20px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            font-size: 13px;
            font-weight: 500;
            color: #cccccc;
        }
        
        .editor-pane {
            border-right: 1px solid #3e3e42;
        }
        
        #latex-input {
            flex: 1;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            outline: none;
        }
        
        #latex-input:focus {
            background: #1e1e1e;
        }
        
        #preview {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #1e1e1e;
        }
        
        .error {
            color: #f48771;
            padding: 10px;
            background: #5a1d1d;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        
        .controls {
            padding: 12px 20px;
            background: #252526;
            border-top: 1px solid #3e3e42;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .mode-toggle {
            display: flex;
            gap: 5px;
        }
        
        .tabs {
            display: flex;
            gap: 0;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
        }
        
        .tab {
            padding: 12px 20px;
            background: transparent;
            color: #858585;
            border: none;
            border-radius: 0;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        
        .tab:hover {
            background: #2d2d30;
            color: #cccccc;
        }
        
        .tab.active {
            background: #1e1e1e;
            color: #ffffff;
            border-bottom: 2px solid #0e639c;
        }
        
        .tool-content {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .tool-content.active {
            display: flex;
        }
        
        #canvas-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
        }
        
        #drawing-canvas {
            flex: 1;
            background: white;
            cursor: crosshair;
            margin: 20px;
            border-radius: 4px;
        }
        
        .canvas-controls {
            padding: 12px 20px;
            background: #252526;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .color-picker {
            width: 40px;
            height: 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .slider {
            width: 100px;
        }
        
        #graph-input {
            flex: 1;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            outline: none;
        }
        
        #graph-canvas {
            flex: 1;
            background: white;
            margin: 20px;
            border-radius: 4px;
        }
        
        #diagram-input {
            flex: 1;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            outline: none;
        }
        
        #diagram-preview {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #1e1e1e;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mermaid {
            background: white;
            padding: 20px;
            border-radius: 4px;
        }
        
        button {
            padding: 6px 12px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #1177bb;
        }
        
        button.active {
            background: #1177bb;
        }
        
        label {
            font-size: 13px;
            color: #cccccc;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #4e4e4e;
        }
    </style>
</head>
<body>
    <header>
        <h1>Live LaTeX Editor</h1>
        <div class="subtitle">Experiment with LaTeX rendering using KaTeX</div>
    </header>
    
    <div class="container">
        <div class="editor-pane">
            <div class="pane-header">LaTeX Input</div>
            <textarea id="latex-input" placeholder="Type your LaTeX here..."># Physics Equations

The Schrödinger equation:
$$i\hbar\frac{\partial}{\partial t}\Psi(\mathbf{r},t) = \hat{H}\Psi(\mathbf{r},t)$$

Maxwell's equations:
$$\nabla \cdot \mathbf{E} = \frac{\rho}{\epsilon_0}$$
$$\nabla \cdot \mathbf{B} = 0$$
$$\nabla \times \mathbf{E} = -\frac{\partial \mathbf{B}}{\partial t}$$
$$\nabla \times \mathbf{B} = \mu_0\mathbf{J} + \mu_0\epsilon_0\frac{\partial \mathbf{E}}{\partial t}$$

The quadratic formula: $x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}$

Einstein's mass-energy equivalence: $E = mc^2$

Integral example:
$$\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}$$

Matrix notation:
$$\begin{pmatrix} a & b \\ c & d \end{pmatrix}$$
</textarea>
        </div>
        
        <div class="preview-pane">
            <div class="tabs">
                <button class="tab active" data-tab="latex-preview">LaTeX Preview</button>
                <button class="tab" data-tab="drawing">Drawing</button>
                <button class="tab" data-tab="graphing">Graphing</button>
                <button class="tab" data-tab="diagrams">Diagrams</button>
            </div>
            
            <div id="latex-preview" class="tool-content active">
                <div id="preview"></div>
            </div>
            
            <div id="drawing" class="tool-content">
                <div id="canvas-container">
                    <canvas id="drawing-canvas"></canvas>
                    <div class="canvas-controls">
                        <label>Color:</label>
                        <input type="color" id="color-picker" class="color-picker" value="#000000">
                        <label>Size:</label>
                        <input type="range" id="brush-size" class="slider" min="1" max="20" value="2">
                        <button id="eraser-btn">Eraser</button>
                        <button id="clear-canvas">Clear</button>
                        <button id="save-canvas">Save PNG</button>
                    </div>
                </div>
            </div>
            
            <div id="graphing" class="tool-content">
                <div style="display: flex; flex-direction: column; flex: 1;">
                    <textarea id="graph-input" placeholder="Enter functions to plot (one per line):
y = x^2
y = sin(x)
y = cos(x)">y = x^2
y = sin(x)
y = 2*cos(x)</textarea>
                    <canvas id="graph-canvas"></canvas>
                    <div class="canvas-controls">
                        <button id="plot-graph">Plot</button>
                        <button id="save-graph">Save PNG</button>
                        <label>Range: x ∈ [</label>
                        <input type="number" id="x-min" value="-10" style="width: 60px;">
                        <label>,</label>
                        <input type="number" id="x-max" value="10" style="width: 60px;">
                        <label>]</label>
                    </div>
                </div>
            </div>
            
            <div id="diagrams" class="tool-content">
                <div style="display: flex; flex-direction: column; flex: 1;">
                    <textarea id="diagram-input" placeholder="Enter Mermaid diagram syntax:">graph TD
    A[Start] --> B{Is it valid?}
    B -->|Yes| C[Process]
    B -->|No| D[Error]
    C --> E[End]
    D --> E
    
sequenceDiagram
    Alice->>John: Hello John!
    John-->>Alice: Hi Alice!
    
flowchart LR
    A[Input] --> B[Process]
    B --> C{Decision}
    C -->|Yes| D[Output A]
    C -->|No| E[Output B]</textarea>
                    <div id="diagram-preview"></div>
                    <div class="canvas-controls">
                        <button id="render-diagram">Render</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="controls">
        <label>Render mode:</label>
        <div class="mode-toggle">
            <button id="auto-mode" class="active">Auto</button>
            <button id="manual-mode">Manual</button>
        </div>
        <button id="render-btn" style="display: none;">Render</button>
    </div>
    
    <!-- KaTeX JS -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <script>
        // LaTeX Editor
        const input = document.getElementById('latex-input');
        const preview = document.getElementById('preview');
        const autoModeBtn = document.getElementById('auto-mode');
        const manualModeBtn = document.getElementById('manual-mode');
        const renderBtn = document.getElementById('render-btn');
        
        // Tab switching
        const tabs = document.querySelectorAll('.tab');
        const toolContents = document.querySelectorAll('.tool-content');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetId = tab.dataset.tab;
                
                tabs.forEach(t => t.classList.remove('active'));
                toolContents.forEach(tc => tc.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(targetId).classList.add('active');
                
                // Initialize canvas sizes when switching tabs
                if (targetId === 'drawing') {
                    resizeDrawingCanvas();
                } else if (targetId === 'graphing') {
                    resizeGraphCanvas();
                }
            });
        });
        
        // Drawing Canvas
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        const colorPicker = document.getElementById('color-picker');
        const brushSize = document.getElementById('brush-size');
        const eraserBtn = document.getElementById('eraser-btn');
        const clearCanvasBtn = document.getElementById('clear-canvas');
        const saveCanvasBtn = document.getElementById('save-canvas');
        
        let isDrawing = false;
        let isEraser = false;
        
        function resizeDrawingCanvas() {
            const container = document.getElementById('canvas-container');
            const rect = container.getBoundingClientRect();
            canvas.width = rect.width - 40;
            canvas.height = rect.height - 80;
        }
        
        function startDrawing(e) {
            isDrawing = true;
            draw(e);
        }
        
        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }
        
        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.lineWidth = brushSize.value;
            ctx.lineCap = 'round';
            
            if (isEraser) {
                ctx.globalCompositeOperation = 'destination-out';
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = colorPicker.value;
            }
            
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }
        
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseout', stopDrawing);
        
        eraserBtn.addEventListener('click', () => {
            isEraser = !isEraser;
            eraserBtn.textContent = isEraser ? 'Pen' : 'Eraser';
            eraserBtn.classList.toggle('active');
        });
        
        clearCanvasBtn.addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });
        
        saveCanvasBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'drawing.png';
            link.href = canvas.toDataURL();
            link.click();
        });
        
        // Graphing Calculator
        const graphCanvas = document.getElementById('graph-canvas');
        const graphCtx = graphCanvas.getContext('2d');
        const graphInput = document.getElementById('graph-input');
        const plotBtn = document.getElementById('plot-graph');
        const saveGraphBtn = document.getElementById('save-graph');
        const xMin = document.getElementById('x-min');
        const xMax = document.getElementById('x-max');
        
        function resizeGraphCanvas() {
            const parent = graphCanvas.parentElement;
            const rect = parent.getBoundingClientRect();
            graphCanvas.width = rect.width - 40;
            graphCanvas.height = Math.min(400, rect.height - 40);
        }
        
        function plotGraph() {
            const width = graphCanvas.width;
            const height = graphCanvas.height;
            
            graphCtx.fillStyle = 'white';
            graphCtx.fillRect(0, 0, width, height);
            
            const xStart = parseFloat(xMin.value);
            const xEnd = parseFloat(xMax.value);
            const xRange = xEnd - xStart;
            
            // Draw axes
            graphCtx.strokeStyle = '#ccc';
            graphCtx.lineWidth = 1;
            
            // Y-axis
            const xZero = (-xStart / xRange) * width;
            if (xZero >= 0 && xZero <= width) {
                graphCtx.beginPath();
                graphCtx.moveTo(xZero, 0);
                graphCtx.lineTo(xZero, height);
                graphCtx.stroke();
            }
            
            // X-axis
            graphCtx.beginPath();
            graphCtx.moveTo(0, height / 2);
            graphCtx.lineTo(width, height / 2);
            graphCtx.stroke();
            
            // Parse and plot functions
            const functions = graphInput.value.split('\n').filter(line => line.trim());
            const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6'];
            
            functions.forEach((func, idx) => {
                try {
                    // Parse y = f(x)
                    const match = func.match(/y\s*=\s*(.+)/);
                    if (!match) return;
                    
                    const expr = match[1].trim();
                    
                    // Calculate y range
                    let yMin = Infinity, yMax = -Infinity;
                    const points = [];
                    
                    for (let px = 0; px < width; px++) {
                        const x = xStart + (px / width) * xRange;
                        const y = evaluateExpression(expr, x);
                        if (!isNaN(y) && isFinite(y)) {
                            points.push({ x, y });
                            yMin = Math.min(yMin, y);
                            yMax = Math.max(yMax, y);
                        }
                    }
                    
                    const yRange = yMax - yMin || 1;
                    const yCenter = (yMax + yMin) / 2;
                    
                    // Plot the function
                    graphCtx.strokeStyle = colors[idx % colors.length];
                    graphCtx.lineWidth = 2;
                    graphCtx.beginPath();
                    
                    let started = false;
                    points.forEach(point => {
                        const px = ((point.x - xStart) / xRange) * width;
                        const py = height / 2 - ((point.y - yCenter) / yRange) * (height * 0.4);
                        
                        if (!started) {
                            graphCtx.moveTo(px, py);
                            started = true;
                        } else {
                            graphCtx.lineTo(px, py);
                        }
                    });
                    
                    graphCtx.stroke();
                } catch (e) {
                    console.error('Error plotting function:', e);
                }
            });
        }
        
        function evaluateExpression(expr, x) {
            // Replace common math functions
            expr = expr.replace(/\^/g, '**');
            expr = expr.replace(/sin/g, 'Math.sin');
            expr = expr.replace(/cos/g, 'Math.cos');
            expr = expr.replace(/tan/g, 'Math.tan');
            expr = expr.replace(/sqrt/g, 'Math.sqrt');
            expr = expr.replace(/log/g, 'Math.log');
            expr = expr.replace(/exp/g, 'Math.exp');
            expr = expr.replace(/abs/g, 'Math.abs');
            
            try {
                return eval(expr);
            } catch (e) {
                return NaN;
            }
        }
        
        plotBtn.addEventListener('click', plotGraph);
        saveGraphBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'graph.png';
            link.href = graphCanvas.toDataURL();
            link.click();
        });
        
        // Diagram rendering
        const diagramInput = document.getElementById('diagram-input');
        const diagramPreview = document.getElementById('diagram-preview');
        const renderDiagramBtn = document.getElementById('render-diagram');
        
        async function renderDiagram() {
            const code = diagramInput.value;
            diagramPreview.innerHTML = '';
            
            try {
                // Split by double newline to handle multiple diagrams
                const diagrams = code.split('\n\n').filter(d => d.trim());
                
                for (let i = 0; i < diagrams.length; i++) {
                    const diagram = diagrams[i].trim();
                    const id = 'mermaid-' + Date.now() + '-' + i;
                    const container = document.createElement('div');
                    container.className = 'mermaid';
                    container.style.marginBottom = '20px';
                    diagramPreview.appendChild(container);
                    
                    const { svg } = await window.mermaid.render(id, diagram);
                    container.innerHTML = svg;
                }
            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = 'Error: ' + error.message;
                diagramPreview.appendChild(errorDiv);
            }
        }
        
        renderDiagramBtn.addEventListener('click', renderDiagram);
        
        // LaTeX rendering (existing code)
        
        let autoMode = true;
        let renderTimeout = null;
        
        function renderLatex() {
            const text = input.value;
            preview.innerHTML = '';
            
            try {
                // Create a temporary div with the text
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = text.replace(/\n/g, '<br>');
                preview.appendChild(tempDiv);
                
                // Render LaTeX with KaTeX
                renderMathInElement(preview, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\[', right: '\\]', display: true},
                        {left: '\\(', right: '\\)', display: false}
                    ],
                    throwOnError: false,
                    errorColor: '#f48771',
                    trust: true
                });
            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = 'Error: ' + error.message;
                preview.appendChild(errorDiv);
            }
        }
        
        function scheduleRender() {
            if (!autoMode) return;
            
            clearTimeout(renderTimeout);
            renderTimeout = setTimeout(renderLatex, 300);
        }
        
        input.addEventListener('input', scheduleRender);
        
        autoModeBtn.addEventListener('click', () => {
            autoMode = true;
            autoModeBtn.classList.add('active');
            manualModeBtn.classList.remove('active');
            renderBtn.style.display = 'none';
            renderLatex();
        });
        
        manualModeBtn.addEventListener('click', () => {
            autoMode = false;
            manualModeBtn.classList.add('active');
            autoModeBtn.classList.remove('active');
            renderBtn.style.display = 'block';
        });
        
        renderBtn.addEventListener('click', renderLatex);
        
        // Initial render
        renderLatex();
        
        // Initialize canvas sizes
        window.addEventListener('resize', () => {
            resizeDrawingCanvas();
            resizeGraphCanvas();
        });
    </script>
</body>
</html>
